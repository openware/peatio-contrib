# frozen_string_literal: true

shared_context 'mocked electrum server' do
  before(:each) do
    auth_headers = {
      'Authorization' => 'Basic dXNlcjpwYXNz'
    }

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"is_synchronized","params":[]}')
      .to_return(status: 200, body: '{"result": true, "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"getbalance","params":[]}')
      .to_return(status: 200, body: '{"result": {"confirmed": "0.011"}, "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"getbalance","params":["poney"]}', headers: auth_headers)
      .to_return(status: 200, body: '{"result": null, "id": 42, "error": {"code": -32602, "message": "Invalid parameters: getbalance() takes 1 positional argument but 2 were given"}}')

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"createnewaddress","params":[]}')
      .to_return(status: 200, body: '{"result": "miACDRY1sVVmznApZv1sSkQXZyhAHNcKHW", "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"listunspent","params":[]}')
      .to_return(status: 200, body: '{"result": [{"address": "n3eDkbbRN8wQECdTcfSvFPRbHW5f9BEJP7", "value": "0.01", "prevout_n": 0, "prevout_hash": "a6840a8ea7e6f713ca8493dd0d59169b812dc775c90d3ff599c7782eb6cb3a27", "height": 1723446, "coinbase": false}, {"address": "mwMVsFVquw2S679z6U72iCJCNXXNbLkVTa", "value": "0.001", "prevout_n": 1, "prevout_hash": "d0c37ddc9f02426307c161e6f486bb547606f57cfebea6daac8d138828a32c89", "height": 1723391, "coinbase": false}, {"address": "mquxiWbT1Nqdt3wbwzEnMvDFrrP5heHkdB", "value": "0.01", "prevout_n": 0, "prevout_hash": "eff4a1aa963e70812272b4b48ab144f87a2789de7dba5290a723950c1fc2ef76", "height": 1723456, "coinbase": false}], "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"history","params":[null,true,false,true,null,null]}')
      .to_return(status: 200, body: '{"result": "{\n    \"summary\": {\n        \"end_balance\": \"0.021\",\n        \"end_date\": null,\n        \"from_height\": null,\n        \"incoming\": \"0.021\",\n        \"outgoing\": \"0.\",\n        \"start_balance\": \"0.\",\n        \"start_date\": null,\n        \"to_height\": null\n    },\n    \"transactions\": [\n        {\n            \"balance\": \"0.001\",\n            \"confirmations\": 117,\n            \"date\": \"2020-05-08 23:42\",\n            \"fee\": \"0.00000168\",\n            \"height\": 1723391,\n            \"incoming\": true,\n            \"inputs\": [\n                {\n                    \"prevout_hash\": \"8f4bf6e4cd722098e9f2a1bdb60188c9d63e9b567c1008fd447528258b37f764\",\n                    \"prevout_n\": 1\n                }\n            ],\n            \"label\": \"\",\n            \"outputs\": [\n                {\n                    \"address\": \"2N6Rt89jaZB1weByMfjYuEeR85r8Gsyn5kG\",\n                    \"value\": \"0.01032157\"\n                },\n                {\n                    \"address\": \"mwMVsFVquw2S679z6U72iCJCNXXNbLkVTa\",\n                    \"value\": \"0.001\"\n                }\n            ],\n            \"timestamp\": 1588970574,\n            \"txid\": \"d0c37ddc9f02426307c161e6f486bb547606f57cfebea6daac8d138828a32c89\",\n            \"txpos_in_block\": 138,\n            \"value\": \"0.001\"\n        },\n        {\n            \"balance\": \"0.011\",\n            \"confirmations\": 62,\n            \"date\": \"2020-05-09 11:07\",\n            \"fee\": null,\n            \"height\": 1723446,\n            \"incoming\": true,\n            \"inputs\": [\n                {\n                    \"prevout_hash\": \"aa86ad5544a29664e16393e949812862a7e16daad6f43962563364515383cedf\",\n                    \"prevout_n\": 1\n                }\n            ],\n            \"label\": \"\",\n            \"outputs\": [\n                {\n                    \"address\": \"n3eDkbbRN8wQECdTcfSvFPRbHW5f9BEJP7\",\n                    \"value\": \"0.01\"\n                },\n                {\n                    \"address\": \"2N5YiTFok4xhN1eM3hbfbzPU5qFuXcufq11\",\n                    \"value\": \"0.06199666\"\n                }\n            ],\n            \"timestamp\": 1589011647,\n            \"txid\": \"a6840a8ea7e6f713ca8493dd0d59169b812dc775c90d3ff599c7782eb6cb3a27\",\n            \"txpos_in_block\": 72,\n            \"value\": \"0.01\"\n        },\n        {\n            \"balance\": \"0.021\",\n            \"confirmations\": 52,\n            \"date\": \"2020-05-09 13:32\",\n            \"fee\": \"0.00000168\",\n            \"height\": 1723456,\n            \"incoming\": true,\n            \"inputs\": [\n                {\n                    \"prevout_hash\": \"ee06a5a9ee9a336d94514b9483460d1e919e082a8f0cf01c462c2322ccb3b0aa\",\n                    \"prevout_n\": 0\n                }\n            ],\n            \"label\": \"\",\n            \"outputs\": [\n                {\n                    \"address\": \"mquxiWbT1Nqdt3wbwzEnMvDFrrP5heHkdB\",\n                    \"value\": \"0.01\"\n                },\n                {\n                    \"address\": \"2N6Ye8Zdg7kVZELMLKAV2WVFtzeQcXDCTw2\",\n                    \"value\": \"0.05099359\"\n                }\n            ],\n            \"timestamp\": 1589020359,\n            \"txid\": \"eff4a1aa963e70812272b4b48ab144f87a2789de7dba5290a723950c1fc2ef76\",\n            \"txpos_in_block\": 131,\n            \"value\": \"0.01\"\n        }\n    ]\n}", "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"history","params":[null,true,false,true,1723391,1723392]}')
      .to_return(status: 200, body: '{"result": "{\n    \"summary\": {\n        \"end_balance\": \"0.021\",\n        \"end_date\": null,\n        \"from_height\": null,\n        \"incoming\": \"0.021\",\n        \"outgoing\": \"0.\",\n        \"start_balance\": \"0.\",\n        \"start_date\": null,\n        \"to_height\": null\n    },\n    \"transactions\": [\n        {\n            \"balance\": \"0.001\",\n            \"confirmations\": 117,\n            \"date\": \"2020-05-08 23:42\",\n            \"fee\": \"0.00000168\",\n            \"height\": 1723391,\n            \"incoming\": true,\n            \"inputs\": [\n                {\n                    \"prevout_hash\": \"8f4bf6e4cd722098e9f2a1bdb60188c9d63e9b567c1008fd447528258b37f764\",\n                    \"prevout_n\": 1\n                }\n            ],\n            \"label\": \"\",\n            \"outputs\": [\n                {\n                    \"address\": \"2N6Rt89jaZB1weByMfjYuEeR85r8Gsyn5kG\",\n                    \"value\": \"0.01032157\"\n                },\n                {\n                    \"address\": \"mwMVsFVquw2S679z6U72iCJCNXXNbLkVTa\",\n                    \"value\": \"0.001\"\n                }\n            ],\n            \"timestamp\": 1588970574,\n            \"txid\": \"d0c37ddc9f02426307c161e6f486bb547606f57cfebea6daac8d138828a32c89\",\n            \"txpos_in_block\": 138,\n            \"value\": \"0.001\"\n        }]\n}", "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"history","params":[null,true,false,true,1723000,1724000]}')
      .to_return(status: 200, body: '{"result": "{\n    \"summary\": {\n        \"end_balance\": \"0.021\",\n        \"end_date\": null,\n        \"from_height\": null,\n        \"incoming\": \"0.021\",\n        \"outgoing\": \"0.\",\n        \"start_balance\": \"0.\",\n        \"start_date\": null,\n        \"to_height\": null\n    },\n    \"transactions\": [\n        {\n            \"balance\": \"0.001\",\n            \"confirmations\": 117,\n            \"date\": \"2020-05-08 23:42\",\n            \"fee\": \"0.00000168\",\n            \"height\": 1723391,\n            \"incoming\": true,\n            \"inputs\": [\n                {\n                    \"prevout_hash\": \"8f4bf6e4cd722098e9f2a1bdb60188c9d63e9b567c1008fd447528258b37f764\",\n                    \"prevout_n\": 1\n                }\n            ],\n            \"label\": \"\",\n            \"outputs\": [\n                {\n                    \"address\": \"2N6Rt89jaZB1weByMfjYuEeR85r8Gsyn5kG\",\n                    \"value\": \"0.01032157\"\n                },\n                {\n                    \"address\": \"mwMVsFVquw2S679z6U72iCJCNXXNbLkVTa\",\n                    \"value\": \"0.001\"\n                }\n            ],\n            \"timestamp\": 1588970574,\n            \"txid\": \"d0c37ddc9f02426307c161e6f486bb547606f57cfebea6daac8d138828a32c89\",\n            \"txpos_in_block\": 138,\n            \"value\": \"0.001\"\n        },\n        {\n            \"balance\": \"0.011\",\n            \"confirmations\": 62,\n            \"date\": \"2020-05-09 11:07\",\n            \"fee\": null,\n            \"height\": 1723446,\n            \"incoming\": true,\n            \"inputs\": [\n                {\n                    \"prevout_hash\": \"aa86ad5544a29664e16393e949812862a7e16daad6f43962563364515383cedf\",\n                    \"prevout_n\": 1\n                }\n            ],\n            \"label\": \"\",\n            \"outputs\": [\n                {\n                    \"address\": \"n3eDkbbRN8wQECdTcfSvFPRbHW5f9BEJP7\",\n                    \"value\": \"0.01\"\n                },\n                {\n                    \"address\": \"2N5YiTFok4xhN1eM3hbfbzPU5qFuXcufq11\",\n                    \"value\": \"0.06199666\"\n                }\n            ],\n            \"timestamp\": 1589011647,\n            \"txid\": \"a6840a8ea7e6f713ca8493dd0d59169b812dc775c90d3ff599c7782eb6cb3a27\",\n            \"txpos_in_block\": 72,\n            \"value\": \"0.01\"\n        },\n        {\n            \"balance\": \"0.021\",\n            \"confirmations\": 52,\n            \"date\": \"2020-05-09 13:32\",\n            \"fee\": \"0.00000168\",\n            \"height\": 1723456,\n            \"incoming\": true,\n            \"inputs\": [\n                {\n                    \"prevout_hash\": \"ee06a5a9ee9a336d94514b9483460d1e919e082a8f0cf01c462c2322ccb3b0aa\",\n                    \"prevout_n\": 0\n                }\n            ],\n            \"label\": \"\",\n            \"outputs\": [\n                {\n                    \"address\": \"mquxiWbT1Nqdt3wbwzEnMvDFrrP5heHkdB\",\n                    \"value\": \"0.01\"\n                },\n                {\n                    \"address\": \"2N6Ye8Zdg7kVZELMLKAV2WVFtzeQcXDCTw2\",\n                    \"value\": \"0.05099359\"\n                }\n            ],\n            \"timestamp\": 1589020359,\n            \"txid\": \"eff4a1aa963e70812272b4b48ab144f87a2789de7dba5290a723950c1fc2ef76\",\n            \"txpos_in_block\": 131,\n            \"value\": \"0.01\"\n        }\n    ]\n}", "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"get_tx_status","params":["d0c37ddc9f02426307c161e6f486bb547606f57cfebea6daac8d138828a32c89"]}')
      .to_return(status: 200, body: '{"result": {"confirmations": 58}, "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '')
      .to_return(status: 200, body: '', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"gettransaction","params":["d0c37ddc9f02426307c161e6f486bb547606f57cfebea6daac8d138828a32c89"]}')
      .to_return(status: 200, body: '{"result": {"hex": "0200000000010164f7378b25287544fd08107c569b3ed6c98801b6bda1f2e9982072cde4f64b8f0100000017160014e26a9cb4accfa5d0ed0195b1a2e2693aa72b3875feffffff02ddbf0f000000000017a914909da0fbb7c1d0947181e2fc9b7e11a2052c150387a0860100000000001976a914adb8354c90d2a5c50bf5b6c786618bc9d1d5f66588ac02473044022035b4e88ff0d5b41d842ddf75a707e2e5e081b445ec6103038a8c4315f7848bfa02201f6182de6d4c40d925f3063e462f5e694b9f52d7103d39365985e95536dcf991012103f600b692c1170c8cf46aeae0c60a3d80447e8e70a0281c56a21aa7097abbd460fe4b1a00", "complete": true, "final": true}, "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"payto","params":["mkHS9ne12qx9pS9VojpwU5xtRd4T7X7ZUt",0.001,null,null,null,false,false,null,null,null]}')
      .to_return(status: 200, body: '{"result": {"hex": "0200000001273acbb62e78c799f53f0dc975c72d819b16590ddd9384ca13f7e6a78e0a84a6000000006b483045022100dc701ee09e0851c62ab8bccf4bd803d2aeef2a2c53d18e082b6cb1658ba1ccdb022003f1cdfca0d1f3019a9ba5fdbdae9e037a81e55dfd9cbe2d92ffbe4123faf85c0121031e80dfe90863c16369970daab2cbdcd9e458323cab63e5fba8ccb8a64c8dc672fdffffff02a0860100000000001976a914344a0f48ca150ec2b903817660b9b68b13a6702688acbeba0d00000000001976a914de832435d134b2119b2fdeb2cb80b20d9a805a6088acc94c1a00", "complete": true, "final": false}, "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"broadcast","params":["0200000001273acbb62e78c799f53f0dc975c72d819b16590ddd9384ca13f7e6a78e0a84a6000000006b483045022100dc701ee09e0851c62ab8bccf4bd803d2aeef2a2c53d18e082b6cb1658ba1ccdb022003f1cdfca0d1f3019a9ba5fdbdae9e037a81e55dfd9cbe2d92ffbe4123faf85c0121031e80dfe90863c16369970daab2cbdcd9e458323cab63e5fba8ccb8a64c8dc672fdffffff02a0860100000000001976a914344a0f48ca150ec2b903817660b9b68b13a6702688acbeba0d00000000001976a914de832435d134b2119b2fdeb2cb80b20d9a805a6088acc94c1a00"]}')
      .to_return(status: 200, body: '{"result": "79e98ec6cb4952906d8b119dec4224e47fc9b0731e08f6a8a2209853b7930ce4", "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"get_local_height","params":[]}')
      .to_return(status: 200, body: '{"result": 305062, "id": 42, "error": null}', headers: auth_headers)

    stub_request(:post, 'http://127.0.0.1:7000')
      .with(body: '{"id":42,"method":"getaddressbalance","params":["yRXYPo6Kvhv81TecNvKUx8oJyihL5vLDXc"]}')
      .to_return(status: 200, body: '{"result": {"confirmed": "1.1818", "unconfirmed": "0"}, "id": 42, "error": null}', headers: auth_headers)
  end
end

# curl --data-binary '{"id":42,"method":"ismine","params":["mquxiWbT1Nqdt3wbwzEnMvDFrrP5heHkdB"]}' http://electrum:changeme@127.0.0.1:7000
# {"result": true, "id": 42, "error": null

# curl --data-binary '{"id":42,"method":"addrequest","params":[1000000,"UID0000003"]}' http://electrum:changeme@127.0.0.1:7000
# {"result": {"time": 1589021093, "amount": 100000000000000, "exp": null, "address": "n2DUxjomdyHvXF2S9SS7azng4RGzZMwn5a", "memo": "UID0000003", "id": "d26962a872", "URI": "bitcoin:n2DUxjomdyHvXF2S9SS7azng4RGzZMwn5a?amount=1000000.", "status": "Pending", "amount (BTC)": "1000000."}, "id": 42, "error": null}
